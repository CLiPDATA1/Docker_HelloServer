##########
# user nginx
# worker_processes: Nginx의 worker 프로세스 수를 선정 1CPU 당 1개의 worker 프로세스를 할당
# error_log: 에러로그 파일 경로 설정
# pid: pid파일 경로 설정
# worker 프로세스의 동시에 처리 할수 있는 연결 수를 지정
#############

user nginx;

worker_processes  1;
error_log  /var/log/nginx/error.log warn; 
pid        /var/run/nginx.pid;

events {                     
    worker_connections  1024;
}

http {
    # 이곳에서 로드 벨런서를 사용할 서버의 그룹을 정의
    upstream django_servers {
        server django_server_master:8000;
        server django_server_slave:8001;
    }

    # Nginx가 포트와 접속자를 요청 처리 방법을 정의
    server {
        # 포트 번호
        listen 80;

        ############
        # location #
        ############
        # /hello: locataion: "/hello"에 처리하도록 하는 구간
        # proxy_http_version: 프록시 서버로 전송 되는 Http 버전을 지정
        # proxy_pass: upstream 구간에서 정의 한 서버의 주소 그룹을 지정
        # proxy_set_header: 프록시 서버로 전송 되는 요청 헤더
        # Host, X-Real-IP, X-Forwarded-For를 지정, 
        # $host: 호스트의 헤더 값, $remote_addr: 클라이어트 실제 IP주소, $proxy_add_x_forwarded_for: 클라이언트가 거친 모든 IP 주소 출력
        ############
        location /hello {
            proxy_http_version 1.1;   
            proxy_pass http://django_servers;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}

# user  nginx;
# worker_processes  1;

# error_log  /var/log/nginx/error.log warn;
# pid        /var/run/nginx.pid;

# events {                     
#     worker_connections  1024;
# }

# http {
#     # 이곳에서 로드 벨런서를 실행
#     upstream django_servers {
#         server django_server_master:8000;
#         server django_server_slave:8001;
#     }
#     # 로드 밸런싱 최적화
#     # 프록시 캐시
#     # proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=10g inactive=60m;

#     server {
#         # 포트 번호
#         listen 80;
#         # 루트 폴더
#         location / {
#             # 로드 밸런싱을 하는 구간
#             proxy_http_version 1.1;
#             proxy_pass http://django_servers;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

#             #### 로드 벨런싱 최적화 #####
#             # 캐싱 구간
#             # Enable caching
#             # proxy_cache my_cache;
#             # proxy_cache_valid 200 302 10m;
#             # proxy_cache_valid 404 1m;

#             # gzip on;
#             # gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
#             # gzip_comp_level 6;
#             # gzip_min_length 1000;
#         }
#     }
# }